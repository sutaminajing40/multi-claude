#!/bin/bash

# ğŸš€ Multi-Claude ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ãƒ»çµ‚äº†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# 2ã¤ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§å®Œå…¨ãªãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰ãƒ»çµ‚äº†

set -e

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
VERSION="1.2.1"

# ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
show_usage() {
    cat << EOF
ğŸ¤– Multi-Claude ã‚·ã‚¹ãƒ†ãƒ 

ä½¿ç”¨æ–¹æ³•:
  $0           - ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
  $0 --exit    - ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨çµ‚äº†
  $0 --help    - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  $0 --version - ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
  $0 --dangerously-skip-permissions - æ¨©é™ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦èµ·å‹•
  $0 "[æŒ‡ç¤º]"  - PRESIDENTã«ç›´æ¥æŒ‡ç¤ºã‚’é€ä¿¡

æ©Ÿèƒ½:
  èµ·å‹•: tmuxç’°å¢ƒæ§‹ç¯‰ + ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹• + Claude Codeèµ·å‹•
  çµ‚äº†: å…¨tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢ + ã‚¿ãƒ¼ãƒŸãƒŠãƒ«é–‰é– + ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
  æŒ‡ç¤º: PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç›´æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
EOF
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º
show_version() {
    echo "Multi-Claude System v${VERSION}"
}

# è‰²ä»˜ããƒ­ã‚°é–¢æ•°
log_info() {
    echo -e "\033[1;32m[INFO]\033[0m $1"
}

log_success() {
    echo -e "\033[1;34m[SUCCESS]\033[0m $1"
}

log_error() {
    echo -e "\033[1;31m[ERROR]\033[0m $1"
}

# ã‚·ã‚¹ãƒ†ãƒ çµ‚äº†æ©Ÿèƒ½
exit_system() {
    echo "ğŸ›‘ Multi-Claude ã‚·ã‚¹ãƒ†ãƒ çµ‚äº†ä¸­..."
    echo "================================="
    
    # STEP 1: tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
    log_info "ğŸ”Œ tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ä¸­..."
    
    if tmux has-session -t multiagent 2>/dev/null; then
        tmux kill-session -t multiagent
        log_info "multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†"
    fi
    
    if tmux has-session -t president 2>/dev/null; then
        tmux kill-session -t president  
        log_info "presidentã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†"
    fi
    
    # ä»–ã®multi-claudeé–¢é€£ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚çµ‚äº†
    tmux list-sessions 2>/dev/null | grep -E "(multiagent|president)" | cut -d: -f1 | xargs -I {} tmux kill-session -t {} 2>/dev/null || true
    
    # STEP 2: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    log_info "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ä¸­..."
    rm -f ./.multi-claude/tmp/worker*_done.txt 2>/dev/null || true
    rm -rf ./.multi-claude/tmp 2>/dev/null || true
    rm -rf ./.multi-claude/logs 2>/dev/null || true
    rm -rf ./.multi-claude/context 2>/dev/null || true
    rm -rf ./.multi-claude/tasks 2>/dev/null || true
    
    # STEP 3: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–‰é–ï¼ˆmacOSã®ã¿ï¼‰
    if [[ "$OSTYPE" == "darwin"* ]]; then
        log_info "ğŸªŸ ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–‰é–ä¸­..."
        osascript << 'EOL' 2>/dev/null || true
tell application "Terminal"
    repeat with w in windows
        repeat with t in tabs of w
            if name of t contains "Multi-Claude" then
                close t
            end if
        end repeat
    end repeat
end tell
EOL
    fi
    
    log_success "âœ… Multi-Claude ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨çµ‚äº†"
    echo ""
    echo "ğŸ‘‹ ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼"
    exit 0
}

# æ¨©é™ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã¨ç›´æ¥æŒ‡ç¤º
SKIP_PERMISSIONS=""
DIRECT_MESSAGE=""

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°å‡¦ç†
case "${1:-}" in
    --exit)
        exit_system
        ;;
    --help|-h)
        show_usage
        exit 0
        ;;
    --version|-v)
        show_version
        exit 0
        ;;
    --dangerously-skip-permissions)
        SKIP_PERMISSIONS="--dangerously-skip-permissions"
        ;;
    "")
        # é€šå¸¸èµ·å‹•ï¼ˆæ—¢å­˜å‡¦ç†ï¼‰
        ;;
    --*)
        echo "âŒ ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
        show_usage
        exit 1
        ;;
    *)
        # ç›´æ¥æŒ‡ç¤ºã¨ã—ã¦æ‰±ã†
        DIRECT_MESSAGE="$1"
        ;;
esac

echo "ğŸ¤– Multi-Claude ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•"
echo "============================="
echo ""

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå–å¾—
CURRENT_DIR=$(pwd)

# Homebrewã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ¤œå‡º
BREW_PREFIX="$(brew --prefix 2>/dev/null || echo '/usr/local')"
if [ -d "${BREW_PREFIX}/Cellar/multi-claude" ]; then
    # HomebrewçµŒç”±ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸå ´åˆ
    # æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
    MULTI_CLAUDE_VERSION=$(ls -1 "${BREW_PREFIX}/Cellar/multi-claude" | sort -V | tail -1)
    MULTI_CLAUDE_BASE="${BREW_PREFIX}/Cellar/multi-claude/${MULTI_CLAUDE_VERSION}"
    MULTI_CLAUDE_BIN="${MULTI_CLAUDE_BASE}/bin"
    MULTI_CLAUDE_SHARE="${MULTI_CLAUDE_BASE}/share"
else
    # ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã®å ´åˆ
    MULTI_CLAUDE_BASE=""
    MULTI_CLAUDE_BIN=""
    MULTI_CLAUDE_SHARE=""
fi

# åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢æ•°
setup_first_time() {
    log_info "ğŸ¯ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™..."
    
    # .multi-claudeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
    mkdir -p ./.multi-claude
    mkdir -p ./.multi-claude/tmp
    mkdir -p ./.multi-claude/logs
    mkdir -p ./.multi-claude/context
    mkdir -p ./.multi-claude/tasks
    mkdir -p ./.multi-claude/bin
    
    # å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
    if [ ! -f "./.multi-claude/bin/setup.sh" ] || [ ! -f "./.multi-claude/bin/agent-send.sh" ] || [ ! -f "./.multi-claude/bin/health-check.sh" ]; then
        log_info "ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ä¸­..."
        
        if [ -n "$MULTI_CLAUDE_BIN" ]; then
            # Homebrewã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆ
            cp "${MULTI_CLAUDE_BIN}/setup.sh" ./.multi-claude/bin/ 2>/dev/null || true
            cp "${MULTI_CLAUDE_BIN}/agent-send.sh" ./.multi-claude/bin/ 2>/dev/null || true
            cp "${MULTI_CLAUDE_BIN}/health-check.sh" ./.multi-claude/bin/ 2>/dev/null || true
        else
            # ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã®å ´åˆï¼ˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆï¼‰
            if [ -f "./setup.sh" ]; then
                cp "./setup.sh" ./.multi-claude/bin/
            fi
            if [ -f "./agent-send.sh" ]; then
                cp "./agent-send.sh" ./.multi-claude/bin/
            fi
            if [ -f "./health-check.sh" ]; then
                cp "./health-check.sh" ./.multi-claude/bin/
            fi
        fi
        
        # å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
        chmod +x ./.multi-claude/bin/setup.sh ./.multi-claude/bin/agent-send.sh ./.multi-claude/bin/health-check.sh 2>/dev/null || true
    fi
    
    # ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†
    if [ -f "./setup.sh" ] && [ -f "./.multi-claude/bin/setup.sh" ]; then
        rm -f "./setup.sh"  # å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    fi
    if [ -f "./agent-send.sh" ] && [ -f "./.multi-claude/bin/agent-send.sh" ]; then
        rm -f "./agent-send.sh"  # å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
    fi
    
    # agent-send.shã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã¯ä½œæˆã—ãªã„ï¼ˆ.multi-claude/bin/ã®ã¿ä½¿ç”¨ï¼‰
    
    # CLAUDE.mdã®å‡¦ç†ï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒï¼‰
    if [ -n "$MULTI_CLAUDE_SHARE" ]; then
        if [ -f "./CLAUDE.md" ]; then
            # æ—¢å­˜ã®CLAUDE.mdãŒã‚ã‚‹å ´åˆã€Multi-Claudeã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’è¿½åŠ 
            log_info "æ—¢å­˜ã®CLAUDE.mdã«Multi-Claudeã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’è¿½åŠ ä¸­..."
            
            # ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãŒæ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! grep -q "## ğŸ¤– Multi-Claude ã‚·ã‚¹ãƒ†ãƒ è¨­å®š" "./CLAUDE.md"; then
                # æ—¢å­˜ã®å†…å®¹ã‚’ä¸€æ™‚ä¿å­˜
                cp "./CLAUDE.md" "./CLAUDE.md.original"
                
                # Multi-Claudeã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’å…ˆé ­ã«è¿½åŠ 
                cp "${MULTI_CLAUDE_SHARE}/CLAUDE_template.md" "./CLAUDE.md.tmp"
                echo "" >> "./CLAUDE.md.tmp"
                echo "---" >> "./CLAUDE.md.tmp"
                echo "" >> "./CLAUDE.md.tmp"
                echo "# å…ƒã®CLAUDE.mdå†…å®¹" >> "./CLAUDE.md.tmp"
                echo "" >> "./CLAUDE.md.tmp"
                cat "./CLAUDE.md.original" >> "./CLAUDE.md.tmp"
                
                # æ–°ã—ã„CLAUDE.mdã¨ã—ã¦ä¿å­˜
                mv "./CLAUDE.md.tmp" "./CLAUDE.md"
                rm "./CLAUDE.md.original"
                
                log_success "âœ… æ—¢å­˜ã®CLAUDE.mdã‚’ä¿æŒã—ã¤ã¤ã€ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’è¿½åŠ ã—ã¾ã—ãŸ"
            else
                log_info "Multi-Claudeã‚·ã‚¹ãƒ†ãƒ è¨­å®šã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™"
            fi
        else
            # CLAUDE.mdãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
            log_info "CLAUDE.mdã‚’ä½œæˆä¸­..."
            cp "${MULTI_CLAUDE_SHARE}/CLAUDE_template.md" "./CLAUDE.md" 2>/dev/null || true
        fi
    fi
    
    # instructionsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ã‹ã€å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯ã‚³ãƒ”ãƒ¼
    if [ ! -d "./.multi-claude/instructions" ] || \
       [ ! -f "./.multi-claude/instructions/president_dynamic.md" ] || \
       [ ! -f "./.multi-claude/instructions/boss_dynamic.md" ] || \
       [ ! -f "./.multi-claude/instructions/worker_dynamic.md" ]; then
        log_info "instructionsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ã‚³ãƒ”ãƒ¼ä¸­..."
        
        # æ—¢å­˜ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
        rm -rf ./.multi-claude/instructions 2>/dev/null || true
        
        # ãƒ­ãƒ¼ã‚«ãƒ«ã®instructionsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å„ªå…ˆï¼ˆãŸã ã—å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
        if [ -d "./instructions" ] && \
           [ -f "./instructions/president_dynamic.md" ] && \
           [ -f "./instructions/boss_dynamic.md" ] && \
           [ -f "./instructions/worker_dynamic.md" ]; then
            cp -r "./instructions" ./.multi-claude/ 2>/dev/null || true
        elif [ -n "$MULTI_CLAUDE_SHARE" ] && [ -d "${MULTI_CLAUDE_SHARE}/instructions" ]; then
            cp -r "${MULTI_CLAUDE_SHARE}/instructions" ./.multi-claude/ 2>/dev/null || true
        fi
    fi
    
    log_success "âœ… åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
}

# STEP 0: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
# Homebrewã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã€ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ãªã„å ´åˆ
# ã¾ãŸã¯ã€instructionsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒç©ºã®å ´åˆ
# ã¾ãŸã¯ã€health-check.shãŒå­˜åœ¨ã—ãªã„å ´åˆ
if ([ -n "$MULTI_CLAUDE_SHARE" ] && ([ ! -f "./.multi-claude/bin/setup.sh" ] || [ ! -f "./CLAUDE.md" ] || [ ! -d "./.multi-claude/instructions" ])) || \
   ([ -z "$MULTI_CLAUDE_SHARE" ] && ([ -f "./setup.sh" ] || [ -f "./agent-send.sh" ]) && [ ! -f "./.multi-claude/bin/setup.sh" ]) || \
   [ ! -f "./.multi-claude/instructions/president_dynamic.md" ] || \
   [ ! -f "./.multi-claude/instructions/boss_dynamic.md" ] || \
   [ ! -f "./.multi-claude/instructions/worker_dynamic.md" ] || \
   [ ! -f "./.multi-claude/bin/health-check.sh" ]; then
    setup_first_time
fi

# STEP 1: ç’°å¢ƒãƒã‚§ãƒƒã‚¯
log_info "ğŸ” ç’°å¢ƒãƒã‚§ãƒƒã‚¯ä¸­..."

# tmuxã®å­˜åœ¨ç¢ºèª
if ! command -v tmux &> /dev/null; then
    log_error "tmuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: brew install tmux"
    exit 1
fi

# Homebrewã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆã®PATHèª¿æ•´
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒã‚¤ãƒŠãƒªãƒ‘ã‚¹ã‚’è¿½åŠ 
export PATH="$HOME/.claude/local:$HOME/.local/bin:$HOME/bin:/usr/local/bin:/opt/homebrew/bin:$PATH"

# claudeã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡ºï¼ˆæ”¹å–„ç‰ˆï¼‰
CLAUDE_CMD=""

# 1. ç›´æ¥ãƒ‘ã‚¹ã‚’æœ€å„ªå…ˆã§ç¢ºèª
if [ -x "$HOME/.claude/local/claude" ]; then
    CLAUDE_CMD="$HOME/.claude/local/claude"
    log_info "ğŸ” claudeã‚’æ¤œå‡º: $CLAUDE_CMD"
# 2. PATHã‹ã‚‰claudeã‚’æ¤œç´¢ï¼ˆwhichä½¿ç”¨ï¼‰
elif which claude >/dev/null 2>&1; then
    CLAUDE_CMD=$(which claude 2>/dev/null)
    log_info "ğŸ” claudeã‚’æ¤œå‡º: $CLAUDE_CMD"
# 3. command -vã§ã‚‚è©¦ã™ï¼ˆbashãƒ“ãƒ«ãƒˆã‚¤ãƒ³ï¼‰
elif command -v claude >/dev/null 2>&1; then
    CLAUDE_CMD="claude"
    log_info "ğŸ” claudeã‚’æ¤œå‡º: command -v claude"
# 4. claude-codeã‚„claude.codeãªã©ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ç¢ºèª
else
    for cmd in claude-code claude.code; do
        if which $cmd >/dev/null 2>&1; then
            CLAUDE_CMD=$(which $cmd 2>/dev/null)
            log_info "ğŸ” claudeã‚’æ¤œå‡º: $CLAUDE_CMD"
            break
        fi
    done
fi

# è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã¿ã‚¨ãƒ©ãƒ¼
if [ -z "$CLAUDE_CMD" ]; then
    log_error "claude commandãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "Claude CodeãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    
    # claudeå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢ã‚’è©¦ã¿ã‚‹
    echo ""
    echo "ğŸ“ claudeã‚³ãƒãƒ³ãƒ‰ã‚’æ¤œç´¢ä¸­..."
    CLAUDE_PATHS=$(find "$HOME" -name "claude*" -type f -perm +111 2>/dev/null | grep -E "(bin|\.local|\.claude)" | head -5)
    if [ -n "$CLAUDE_PATHS" ]; then
        echo "ä»¥ä¸‹ã®å ´æ‰€ã§è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
        echo "$CLAUDE_PATHS"
        echo ""
        echo "PATHã«è¿½åŠ ã™ã‚‹ã«ã¯:"
        echo "export PATH=\"\$(dirname \$(echo '$CLAUDE_PATHS' | head -1)):\$PATH\""
    fi
    exit 1
fi

log_success "âœ… ç’°å¢ƒãƒã‚§ãƒƒã‚¯å®Œäº†"

# STEP 2: tmuxç’°å¢ƒæ§‹ç¯‰
log_info "ğŸ—ï¸  tmuxç’°å¢ƒæ§‹ç¯‰ä¸­..."

# setup.shã‚’å®Ÿè¡Œï¼ˆæ—¢å­˜ã®ç’°å¢ƒæ§‹ç¯‰ï¼‰
if [ -f "./.multi-claude/bin/setup.sh" ]; then
    ./.multi-claude/bin/setup.sh || {
        log_error "setup.shã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
    }
elif [ -f "./setup.sh" ]; then
    # å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
    ./setup.sh || {
        log_error "setup.shã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
    }
    
    # tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã®ç¢ºèª
    sleep 1
    if ! tmux has-session -t multiagent 2>/dev/null; then
        log_error "multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
    fi
    if ! tmux has-session -t president 2>/dev/null; then
        log_error "presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
        exit 1
    fi
    log_info "âœ… tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚’ç¢ºèª"
else
    log_error "setup.shãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "ãƒ’ãƒ³ãƒˆ: multi-claudeã‚’å®Ÿè¡Œã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«setup.shãŒå¿…è¦ã§ã™"
    echo "Homebrewã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå ´åˆã¯ã€åˆå›å®Ÿè¡Œæ™‚ã«è‡ªå‹•ã§ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™"
    exit 1
fi

# STEP 3: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹•
log_info "ğŸ’» ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹•ä¸­..."

# OSã®æ¤œå‡º
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    TERMINAL_APP="Terminal"
    
    # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦1: PRESIDENTï¼ˆãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰
    osascript << EOF 2>/dev/null
tell application "$TERMINAL_APP"
    activate
    do script "cd '$CURRENT_DIR' && echo 'ğŸ¯ PRESIDENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t president"
    delay 1
    set currentWindow to front window
    set currentTab to selected tab of currentWindow
    try
        tell currentTab
            set custom title to "Multi-Claude: PRESIDENT"
        end tell
    on error
        -- ã‚¿ã‚¤ãƒˆãƒ«è¨­å®šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
    end try
end tell
EOF
    
    if [ $? -ne 0 ]; then
        log_error "PRESIDENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo "æ‰‹å‹•ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
        echo "tmux attach-session -t president"
        exit 1
    fi

    sleep 2

    # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦2: MULTIAGENTï¼ˆã‚µãƒ–ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰
    osascript << EOF 2>/dev/null
tell application "$TERMINAL_APP"
    do script "cd '$CURRENT_DIR' && echo 'ğŸ‘¥ MULTIAGENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t multiagent"
    delay 1
    set currentWindow to front window
    set currentTab to selected tab of currentWindow
    try
        tell currentTab
            set custom title to "Multi-Claude: MULTIAGENT"
        end tell
    on error
        -- ã‚¿ã‚¤ãƒˆãƒ«è¨­å®šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
    end try
end tell
EOF
    
    if [ $? -ne 0 ]; then
        log_error "MULTIAGENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo "æ‰‹å‹•ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
        echo "tmux attach-session -t multiagent"
        exit 1
    fi

elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux
    if command -v gnome-terminal &> /dev/null; then
        # GNOME Terminal
        gnome-terminal --title="Multi-Claude: PRESIDENT" -- bash -c "cd '$CURRENT_DIR' && echo 'ğŸ¯ PRESIDENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t president; exec bash" &
        sleep 2
        gnome-terminal --title="Multi-Claude: MULTIAGENT" -- bash -c "cd '$CURRENT_DIR' && echo 'ğŸ‘¥ MULTIAGENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t multiagent; exec bash" &
    elif command -v xterm &> /dev/null; then
        # xterm
        xterm -title "Multi-Claude: PRESIDENT" -e "cd '$CURRENT_DIR' && echo 'ğŸ¯ PRESIDENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t president" &
        sleep 2
        xterm -title "Multi-Claude: MULTIAGENT" -e "cd '$CURRENT_DIR' && echo 'ğŸ‘¥ MULTIAGENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t multiagent" &
    else
        log_error "å¯¾å¿œã™ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi
else
    log_error "å¯¾å¿œã—ã¦ã„ãªã„OS: $OSTYPE"
    exit 1
fi

log_success "âœ… ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹•å®Œäº†"

# STEP 4: Claude Codeè‡ªå‹•èµ·å‹•ã¨åˆæœŸã‚¿ã‚¹ã‚¯ç¢ºèª
log_info "â³ Claude Codeèµ·å‹•æº–å‚™ä¸­..."
sleep 5
log_info "ğŸ¤– Claude Codeè‡ªå‹•èµ·å‹•ä¸­..."

# PRESIDENTèµ·å‹•
log_info "ğŸ‘‘ PRESIDENTèµ·å‹•ä¸­..."
if ! tmux send-keys -t president "$CLAUDE_CMD $SKIP_PERMISSIONS" C-m; then
    log_error "PRESIDENTã¸ã®Claude Codeèµ·å‹•ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã«å¤±æ•—"
    exit 1
fi
sleep 3

# MULTIAGENTèµ·å‹•ï¼ˆå…¨ãƒšã‚¤ãƒ³ï¼‰
for i in {0..3}; do
    case $i in
        0) agent_name="boss1" ;;
        1) agent_name="worker1" ;;
        2) agent_name="worker2" ;;
        3) agent_name="worker3" ;;
    esac
    log_info "ğŸ¤– $agent_name èµ·å‹•ä¸­..."
    if ! tmux send-keys -t multiagent:0.$i "$CLAUDE_CMD $SKIP_PERMISSIONS" C-m; then
        log_error "$agent_name ã¸ã®Claude Codeèµ·å‹•ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã«å¤±æ•—"
        exit 1
    fi
    sleep 2
done

log_success "âœ… Claude Codeèµ·å‹•å®Œäº†"

# STEP 4.5: ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèªã¨ã‚¿ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯
log_info "ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèªä¸­..."
sleep 3

# å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«èµ·å‹•ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
log_info "ğŸ“¡ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€šä¿¡ãƒ†ã‚¹ãƒˆä¸­..."

# ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
mkdir -p ./.multi-claude/tasks
echo "Multi-Claude System Started at $(date)" > ./.multi-claude/tasks/system_status.txt

# å‰å›ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
if [ -f "./.multi-claude/tasks/current_task.md" ]; then
    log_info "ğŸ“‹ å‰å›ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
    echo ""
    echo "===== æœªå®Œäº†ã‚¿ã‚¹ã‚¯ ====="
    head -5 ./.multi-claude/tasks/current_task.md
    echo "========================"
    echo ""
    
    # PRESIDENTã«æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®ç¢ºèªã‚’ä¿ƒã™
    sleep 2
    if [ -f "./.multi-claude/bin/agent-send.sh" ]; then
        ./.multi-claude/bin/agent-send.sh president "ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚å‰å›ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚.multi-claude/tasks/current_task.mdã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    fi
fi

log_success "âœ… ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèªå®Œäº†"

# STEP 5: ç›´æ¥æŒ‡ç¤ºã®é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
if [ -n "$DIRECT_MESSAGE" ]; then
    log_info "ğŸ“¨ PRESIDENTã¸ç›´æ¥æŒ‡ç¤ºã‚’é€ä¿¡ä¸­..."
    sleep 2
    
    # agent-send.shã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    if [ -f "./.multi-claude/bin/agent-send.sh" ]; then
        ./.multi-claude/bin/agent-send.sh president "$DIRECT_MESSAGE"
    elif [ -f "./agent-send.sh" ]; then
        # å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
        ./agent-send.sh president "$DIRECT_MESSAGE"
        log_success "âœ… æŒ‡ç¤ºã‚’é€ä¿¡ã—ã¾ã—ãŸ"
        
        # PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
        echo ""
        echo "ğŸ” PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶šä¸­..."
        echo "   çµ‚äº†ã™ã‚‹ã«ã¯: Ctrl+B â†’ D"
        sleep 2
        tmux attach-session -t president
    else
        log_error "agent-send.shãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi
else
    echo ""
    echo "ğŸ‰ Multi-Claude ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†ï¼"
    echo "=================================="
    echo ""
    echo "ğŸ“‹ ä½¿ç”¨æ–¹æ³•:"
    echo "  1. ğŸ¯ PRESIDENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: ãƒ¡ã‚¤ãƒ³ã®å¯¾è©±çª“å£"
    echo "  2. ğŸ‘¥ MULTIAGENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: BOSS+WORKERsç›£è¦–ç”¨"
    echo ""
    echo "ğŸ’¬ PRESIDENTã«è©±ã—ã‹ã‘ã¦ã‚¿ã‚¹ã‚¯ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ï¼š"
    echo "     ä¾‹: ã€ŒPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’3äººã§ä½œã£ã¦ã€"
    echo ""
    echo "ğŸ’¡ ç›´æ¥æŒ‡ç¤ºã‚‚å¯èƒ½:"
    echo "     multi-claude \"Pythonã§è¨ˆç®—æ©Ÿã‚’ä½œã£ã¦\""
    echo ""
    echo "ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡:"
    echo "  çµ‚äº†: Ctrl+C ã§Claudeçµ‚äº†ã€tmux kill-server ã§å®Œå…¨ãƒªã‚»ãƒƒãƒˆ"
    echo "  å†èµ·å‹•: multi-claude"
    echo ""
    
    # è‡ªå‹•çš„ã«PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
    echo "ğŸ” PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è‡ªå‹•æ¥ç¶šä¸­..."
    echo "   ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æŠœã‘ã‚‹ã«ã¯: Ctrl+B â†’ D"
    echo "   MULTIAGENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç¢ºèªã™ã‚‹ã«ã¯åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§: tmux attach-session -t multiagent"
    sleep 3
    
    # PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
    tmux attach-session -t president
fi