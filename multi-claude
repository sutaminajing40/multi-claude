#!/bin/bash

# ğŸš€ Multi-Claude ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ãƒ»çµ‚äº†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# 2ã¤ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§å®Œå…¨ãªãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰ãƒ»çµ‚äº†

set -e

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
VERSION="1.3.2"

# ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
show_usage() {
    cat << EOF
ğŸ¤– Multi-Claude ã‚·ã‚¹ãƒ†ãƒ 

ä½¿ç”¨æ–¹æ³•:
  $0           - ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ï¼ˆé€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼‰
  $0 --exit    - ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨çµ‚äº†
  $0 --help    - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  $0 --version - ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
  $0 --dangerously-skip-permissions - æ¨©é™ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦èµ·å‹•ï¼ˆClaudeã«--dangerously-skip-permissionsã‚’ä»˜ä¸ï¼‰
  $0 --reset-terminal - ã‚¿ãƒ¼ãƒŸãƒŠãƒ«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
  $0 "[æŒ‡ç¤º]"  - PRESIDENTã«ç›´æ¥æŒ‡ç¤ºã‚’é€ä¿¡

æ©Ÿèƒ½:
  èµ·å‹•: tmuxç’°å¢ƒæ§‹ç¯‰ + ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹• + Claude Codeèµ·å‹•
  çµ‚äº†: å…¨tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢ + ã‚¿ãƒ¼ãƒŸãƒŠãƒ«é–‰é– + ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
  æŒ‡ç¤º: PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ç›´æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
EOF
}

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º
show_version() {
    echo "Multi-Claude System v${VERSION}"
}

# è‰²ä»˜ããƒ­ã‚°é–¢æ•°
log_info() {
    echo -e "\033[1;32m[INFO]\033[0m $1"
}

log_success() {
    echo -e "\033[1;34m[SUCCESS]\033[0m $1"
}

log_error() {
    echo -e "\033[1;31m[ERROR]\033[0m $1"
}

# ã‚·ã‚¹ãƒ†ãƒ çµ‚äº†æ©Ÿèƒ½
exit_system() {
    echo "ğŸ›‘ Multi-Claude ã‚·ã‚¹ãƒ†ãƒ çµ‚äº†ä¸­..."
    echo "================================="
    
    # STEP 1: tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
    log_info "ğŸ”Œ tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ä¸­..."
    
    if tmux has-session -t multiagent 2>/dev/null; then
        tmux kill-session -t multiagent
        log_info "multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†"
    fi
    
    if tmux has-session -t president 2>/dev/null; then
        tmux kill-session -t president  
        log_info "presidentã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†"
    fi
    
    # ä»–ã®multi-claudeé–¢é€£ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚çµ‚äº†
    tmux list-sessions 2>/dev/null | grep -E "(multiagent|president)" | cut -d: -f1 | xargs -I {} tmux kill-session -t {} 2>/dev/null || true
    
    # STEP 2: ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    log_info "ğŸ§¹ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ä¸­..."
    rm -f "$MULTI_CLAUDE_LOCAL/tmp/worker*_done.txt" 2>/dev/null || true
    rm -rf "$MULTI_CLAUDE_LOCAL/tmp" 2>/dev/null || true
    rm -rf "$MULTI_CLAUDE_LOCAL/logs" 2>/dev/null || true
    rm -rf "$MULTI_CLAUDE_LOCAL/context" 2>/dev/null || true
    rm -rf "$MULTI_CLAUDE_LOCAL/tasks" 2>/dev/null || true
    
    # STEP 3: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–‰é–ï¼ˆmacOSã®ã¿ï¼‰
    if [[ "$OSTYPE" == "darwin"* ]]; then
        log_info "ğŸªŸ ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦é–‰é–ä¸­..."
        # è¨­å®šã•ã‚ŒãŸã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¢ãƒ—ãƒªã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‰é–
        CONFIG_DIR="$HOME/.multi-claude"
        CONFIG_FILE="$CONFIG_DIR/config"
        
        # è¨­å®šã‚’èª­ã¿è¾¼ã¿
        if [ -f "$CONFIG_FILE" ]; then
            source "$CONFIG_FILE"
        fi
        
        if [ "$TERMINAL_APP" = "iTerm" ]; then
            # iTerm2ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‰é–
            osascript << 'EOL' 2>/dev/null || true
tell application "iTerm2"
    repeat with w in windows
        tell w
            repeat with t in tabs
                tell t
                    repeat with s in sessions
                        if name of s contains "Multi-Claude" then
                            close s
                        end if
                    end repeat
                end tell
            end repeat
        end tell
    end repeat
end tell
EOL
        else
            # æ¨™æº–ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®é–‰é–
            osascript << 'EOL' 2>/dev/null || true
tell application "Terminal"
    repeat with w in windows
        repeat with t in tabs of w
            if name of t contains "Multi-Claude" then
                close t
            end if
        end repeat
    end repeat
end tell
EOL
        fi
    fi
    
    log_success "âœ… Multi-Claude ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨çµ‚äº†"
    echo ""
    echo "ğŸ‘‹ ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼"
    exit 0
}

# æ¨©é™ã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã¨ç›´æ¥æŒ‡ç¤º
SKIP_PERMISSIONS=""
DIRECT_MESSAGE=""

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°å‡¦ç†
case "${1:-}" in
    --exit)
        exit_system
        ;;
    --help|-h)
        show_usage
        exit 0
        ;;
    --version|-v)
        show_version
        exit 0
        ;;
    --reset-terminal)
        # ã‚¿ãƒ¼ãƒŸãƒŠãƒ«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
        CONFIG_DIR="$HOME/.multi-claude"
        CONFIG_FILE="$CONFIG_DIR/config"
        if [ -f "$CONFIG_FILE" ]; then
            rm "$CONFIG_FILE"
            log_success "âœ“ ã‚¿ãƒ¼ãƒŸãƒŠãƒ«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"
            echo "æ¬¡å›èµ·å‹•æ™‚ã«ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é¸æŠã§ãã¾ã™ã€‚"
        else
            log_info "ã‚¿ãƒ¼ãƒŸãƒŠãƒ«è¨­å®šã¯ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“"
        fi
        exit 0
        ;;
    --dangerously-skip-permissions)
        SKIP_PERMISSIONS="--dangerously-skip-permissions"
        ;;
    "")
        # é€šå¸¸èµ·å‹•ï¼ˆæ—¢å­˜å‡¦ç†ï¼‰
        ;;
    --*)
        echo "âŒ ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
        show_usage
        exit 1
        ;;
    *)
        # ç›´æ¥æŒ‡ç¤ºã¨ã—ã¦æ‰±ã†
        DIRECT_MESSAGE="$1"
        ;;
esac

echo "ğŸ¤– Multi-Claude ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•"
echo "============================="
echo ""

# ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå–å¾—
CURRENT_DIR=$(pwd)

# Homebrewã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ¤œå‡º
BREW_PREFIX="$(brew --prefix 2>/dev/null || echo '/usr/local')"
if [ -d "${BREW_PREFIX}/Cellar/multi-claude" ]; then
    # HomebrewçµŒç”±ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸå ´åˆ
    # æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
    MULTI_CLAUDE_VERSION=$(ls -1 "${BREW_PREFIX}/Cellar/multi-claude" | sort -V | tail -1)
    MULTI_CLAUDE_BASE="${BREW_PREFIX}/Cellar/multi-claude/${MULTI_CLAUDE_VERSION}"
    MULTI_CLAUDE_BIN="${MULTI_CLAUDE_BASE}/bin"
    MULTI_CLAUDE_SHARE="${MULTI_CLAUDE_BASE}/share"
else
    # ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã®å ´åˆ
    MULTI_CLAUDE_BASE=""
    MULTI_CLAUDE_BIN=""
    MULTI_CLAUDE_SHARE=""
fi

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‘ã‚¹è¨­å®šï¼ˆæ—©æœŸã«è¨­å®šï¼‰
if [ -n "$MULTI_CLAUDE_BASE" ] && [ -d "$MULTI_CLAUDE_BASE" ]; then
    # Homebrewã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆ
    export MULTI_CLAUDE_GLOBAL="$MULTI_CLAUDE_BASE"
elif [ -d "$HOME/.multi-claude" ]; then
    # install.shã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆ
    export MULTI_CLAUDE_GLOBAL="$HOME/.multi-claude"
else
    # ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã®å ´åˆ
    export MULTI_CLAUDE_GLOBAL="$(pwd)"
fi

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹è¨­å®š
export MULTI_CLAUDE_LOCAL="$(pwd)/.multi-claude"

# åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–¢æ•°
setup_first_time() {
    log_info "ğŸ¯ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œã—ã¾ã™..."
    
    # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
    mkdir -p "$MULTI_CLAUDE_LOCAL/session/tmp"
    mkdir -p "$MULTI_CLAUDE_LOCAL/session/logs"
    mkdir -p "$MULTI_CLAUDE_LOCAL/session/runtime"
    mkdir -p "$MULTI_CLAUDE_LOCAL/context"
    mkdir -p "$MULTI_CLAUDE_LOCAL/tasks"
    mkdir -p "$MULTI_CLAUDE_LOCAL/config"
    mkdir -p "$MULTI_CLAUDE_LOCAL/instructions"
    
    # CLAUDE.mdã®å‡¦ç†ï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒï¼‰
    CLAUDE_TEMPLATE_PATH=""
    if [ -n "$MULTI_CLAUDE_SHARE" ]; then
        CLAUDE_TEMPLATE_PATH="${MULTI_CLAUDE_SHARE}/CLAUDE_template.md"
    elif [ -f "$HOME/.multi-claude/share/CLAUDE_template.md" ]; then
        CLAUDE_TEMPLATE_PATH="$HOME/.multi-claude/share/CLAUDE_template.md"
    elif [ -f "$MULTI_CLAUDE_GLOBAL/share/CLAUDE_template.md" ]; then
        CLAUDE_TEMPLATE_PATH="$MULTI_CLAUDE_GLOBAL/share/CLAUDE_template.md"
    fi
    
    if [ -n "$CLAUDE_TEMPLATE_PATH" ]; then
        log_info "CLAUDE_template.mdã‚’æ¤œå‡º: $CLAUDE_TEMPLATE_PATH"
        if [ -f "./CLAUDE.md" ]; then
            # æ—¢å­˜ã®CLAUDE.mdãŒã‚ã‚‹å ´åˆã€Multi-Claudeã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’è¿½åŠ 
            log_info "æ—¢å­˜ã®CLAUDE.mdã«Multi-Claudeã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’è¿½åŠ ä¸­..."
            
            # ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãŒæ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if ! grep -q "## ğŸ¤– Multi-Claude ã‚·ã‚¹ãƒ†ãƒ è¨­å®š" "./CLAUDE.md"; then
                # æ—¢å­˜ã®å†…å®¹ã‚’ä¸€æ™‚ä¿å­˜
                cp "./CLAUDE.md" "./CLAUDE.md.original"
                
                # Multi-Claudeã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’å…ˆé ­ã«è¿½åŠ ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®ãæ›ãˆï¼‰
                sed -e "s|\[STARTUP_TIME\]|$(date '+%Y-%m-%d %H:%M:%S')|g" \
                    -e "s|\[PROJECT_PATH\]|$(pwd)|g" \
                    -e "s|\[GLOBAL_PATH\]|$MULTI_CLAUDE_GLOBAL|g" \
                    -e "s|\[LOCAL_PATH\]|$MULTI_CLAUDE_LOCAL|g" \
                    "$CLAUDE_TEMPLATE_PATH" > "./CLAUDE.md.tmp"
                echo "" >> "./CLAUDE.md.tmp"
                echo "---" >> "./CLAUDE.md.tmp"
                echo "" >> "./CLAUDE.md.tmp"
                echo "# å…ƒã®CLAUDE.mdå†…å®¹" >> "./CLAUDE.md.tmp"
                echo "" >> "./CLAUDE.md.tmp"
                cat "./CLAUDE.md.original" >> "./CLAUDE.md.tmp"
                
                # æ–°ã—ã„CLAUDE.mdã¨ã—ã¦ä¿å­˜
                mv "./CLAUDE.md.tmp" "./CLAUDE.md"
                rm "./CLAUDE.md.original"
                
                log_success "âœ… æ—¢å­˜ã®CLAUDE.mdã‚’ä¿æŒã—ã¤ã¤ã€ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’è¿½åŠ ã—ã¾ã—ãŸ"
            else
                log_info "Multi-Claudeã‚·ã‚¹ãƒ†ãƒ è¨­å®šã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™"
            fi
        else
            # CLAUDE.mdãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®ãæ›ãˆï¼‰
            log_info "CLAUDE.mdã‚’ä½œæˆä¸­..."
            sed -e "s|\[STARTUP_TIME\]|$(date '+%Y-%m-%d %H:%M:%S')|g" \
                -e "s|\[PROJECT_PATH\]|$(pwd)|g" \
                -e "s|\[GLOBAL_PATH\]|$MULTI_CLAUDE_GLOBAL|g" \
                -e "s|\[LOCAL_PATH\]|$MULTI_CLAUDE_LOCAL|g" \
                "$CLAUDE_TEMPLATE_PATH" > "./CLAUDE.md"
        fi
    else
        log_error "CLAUDE_template.mdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        log_info "  æ¤œç´¢ãƒ‘ã‚¹:"
        log_info "  - $HOME/.multi-claude/share/CLAUDE_template.md"
        log_info "  - $MULTI_CLAUDE_GLOBAL/share/CLAUDE_template.md"
    fi
    
    # æŒ‡ç¤ºæ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒ”ãƒ¼
    log_info "æŒ‡ç¤ºæ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚³ãƒ”ãƒ¼ä¸­..."
    if [ -d "$MULTI_CLAUDE_GLOBAL/instructions" ]; then
        cp "$MULTI_CLAUDE_GLOBAL/instructions/president_dynamic.md" "$MULTI_CLAUDE_LOCAL/instructions/" 2>/dev/null || true
        cp "$MULTI_CLAUDE_GLOBAL/instructions/boss_dynamic.md" "$MULTI_CLAUDE_LOCAL/instructions/" 2>/dev/null || true
        cp "$MULTI_CLAUDE_GLOBAL/instructions/worker_dynamic.md" "$MULTI_CLAUDE_LOCAL/instructions/" 2>/dev/null || true
        cp "$MULTI_CLAUDE_GLOBAL/instructions/architect_dynamic.md" "$MULTI_CLAUDE_LOCAL/instructions/" 2>/dev/null || true
        cp "$MULTI_CLAUDE_GLOBAL/instructions/qa_dynamic.md" "$MULTI_CLAUDE_LOCAL/instructions/" 2>/dev/null || true
        log_success "âœ… æŒ‡ç¤ºæ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
    else
        log_error "ã‚°ãƒ­ãƒ¼ãƒãƒ«æŒ‡ç¤ºæ›¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $MULTI_CLAUDE_GLOBAL/instructions"
    fi
    
    log_success "âœ… åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"
}

# STEP 0: åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
if [ ! -d "$MULTI_CLAUDE_LOCAL/session" ] || [ ! -f "./CLAUDE.md" ]; then
    setup_first_time
fi

# STEP 1: ç’°å¢ƒãƒã‚§ãƒƒã‚¯
log_info "ğŸ” ç’°å¢ƒãƒã‚§ãƒƒã‚¯ä¸­..."

# tmuxã®å­˜åœ¨ç¢ºèª
if ! command -v tmux &> /dev/null; then
    log_error "tmuxãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: brew install tmux"
    exit 1
fi

# Homebrewã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆã®PATHèª¿æ•´
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒã‚¤ãƒŠãƒªãƒ‘ã‚¹ã‚’è¿½åŠ 
export PATH="$HOME/.claude/local:$HOME/.local/bin:$HOME/bin:/usr/local/bin:/opt/homebrew/bin:$PATH"

# claudeã‚³ãƒãƒ³ãƒ‰ã®æ¤œå‡ºï¼ˆæ”¹å–„ç‰ˆï¼‰
CLAUDE_CMD=""

# 1. ç›´æ¥ãƒ‘ã‚¹ã‚’æœ€å„ªå…ˆã§ç¢ºèª
if [ -x "$HOME/.claude/local/claude" ]; then
    CLAUDE_CMD="$HOME/.claude/local/claude"
    log_info "ğŸ” claudeã‚’æ¤œå‡º: $CLAUDE_CMD"
# 2. PATHã‹ã‚‰claudeã‚’æ¤œç´¢ï¼ˆwhichä½¿ç”¨ï¼‰
elif which claude >/dev/null 2>&1; then
    CLAUDE_CMD=$(which claude 2>/dev/null)
    log_info "ğŸ” claudeã‚’æ¤œå‡º: $CLAUDE_CMD"
# 3. command -vã§ã‚‚è©¦ã™ï¼ˆbashãƒ“ãƒ«ãƒˆã‚¤ãƒ³ï¼‰
elif command -v claude >/dev/null 2>&1; then
    CLAUDE_CMD="claude"
    log_info "ğŸ” claudeã‚’æ¤œå‡º: command -v claude"
# 4. claude-codeã‚„claude.codeãªã©ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ç¢ºèª
else
    for cmd in claude-code claude.code; do
        if which $cmd >/dev/null 2>&1; then
            CLAUDE_CMD=$(which $cmd 2>/dev/null)
            log_info "ğŸ” claudeã‚’æ¤œå‡º: $CLAUDE_CMD"
            break
        fi
    done
fi

# è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ã¿ã‚¨ãƒ©ãƒ¼
if [ -z "$CLAUDE_CMD" ]; then
    log_error "claude commandãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "Claude CodeãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
    
    # claudeå®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢ã‚’è©¦ã¿ã‚‹
    echo ""
    echo "ğŸ“ claudeã‚³ãƒãƒ³ãƒ‰ã‚’æ¤œç´¢ä¸­..."
    CLAUDE_PATHS=$(find "$HOME" -name "claude*" -type f -perm +111 2>/dev/null | grep -E "(bin|\.local|\.claude)" | head -5)
    if [ -n "$CLAUDE_PATHS" ]; then
        echo "ä»¥ä¸‹ã®å ´æ‰€ã§è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
        echo "$CLAUDE_PATHS"
        echo ""
        echo "PATHã«è¿½åŠ ã™ã‚‹ã«ã¯:"
        echo "export PATH=\"\$(dirname \$(echo '$CLAUDE_PATHS' | head -1)):\$PATH\""
    fi
    exit 1
fi

log_success "âœ… ç’°å¢ƒãƒã‚§ãƒƒã‚¯å®Œäº†"

# STEP 2: tmuxç’°å¢ƒæ§‹ç¯‰
log_info "ğŸ—ï¸  tmuxç’°å¢ƒæ§‹ç¯‰ä¸­..."

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‘ã‚¹ã‹ã‚‰setup.shã‚’å®Ÿè¡Œ
SETUP_SCRIPT=""
if [ -f "$MULTI_CLAUDE_GLOBAL/bin/setup.sh" ]; then
    SETUP_SCRIPT="$MULTI_CLAUDE_GLOBAL/bin/setup.sh"
elif [ -f "$MULTI_CLAUDE_GLOBAL/setup.sh" ]; then
    SETUP_SCRIPT="$MULTI_CLAUDE_GLOBAL/setup.sh"
elif [ -f "./setup.sh" ]; then
    # ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œã®å ´åˆ
    SETUP_SCRIPT="./setup.sh"
else
    log_error "setup.shãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæ­£ã—ãå®Œäº†ã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
    exit 1
fi

# setup.shå®Ÿè¡Œ
$SETUP_SCRIPT || {
    log_error "setup.shã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
    exit 1
}

# tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã®ç¢ºèª
sleep 1
if ! tmux has-session -t multiagent 2>/dev/null; then
    log_error "multiagentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
    exit 1
fi
if ! tmux has-session -t president 2>/dev/null; then
    log_error "presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ"
    exit 1
fi
log_info "âœ… tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚’ç¢ºèª"

# STEP 3: ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹•
log_info "ğŸ’» MULTIAGENTã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹•ä¸­..."

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
CONFIG_DIR="$HOME/.multi-claude"
CONFIG_FILE="$CONFIG_DIR/config"

# è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if [ ! -d "$CONFIG_DIR" ]; then
    mkdir -p "$CONFIG_DIR"
fi

# ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¢ãƒ—ãƒªã®è¨­å®šã‚’èª­ã¿è¾¼ã¿
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# OSã®æ¤œå‡º
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    # ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¢ãƒ—ãƒªãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯é¸æŠã‚’ä¿ƒã™
    if [ -z "$TERMINAL_APP" ]; then
        echo ""
        echo "ğŸ–¥  ä½¿ç”¨ã™ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¢ãƒ—ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„:"
        echo "1) Terminal (æ¨™æº–ã‚¿ãƒ¼ãƒŸãƒŠãƒ«)"
        echo "2) iTerm2"
        echo ""
        read -p "é¸æŠ (1 ã¾ãŸã¯ 2): " choice
        
        case $choice in
            1)
                TERMINAL_APP="Terminal"
                ;;
            2)
                # iTerm2ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                if osascript -e 'tell application "System Events" to name of application processes' 2>/dev/null | grep -q "iTerm"; then
                    TERMINAL_APP="iTerm"
                else
                    echo ""
                    log_error "iTerm2ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ¨™æº–ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
                    TERMINAL_APP="Terminal"
                    sleep 2
                fi
                ;;
            *)
                echo "ç„¡åŠ¹ãªé¸æŠã§ã™ã€‚æ¨™æº–ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
                TERMINAL_APP="Terminal"
                ;;
        esac
        
        # è¨­å®šã‚’ä¿å­˜
        echo "TERMINAL_APP=\"$TERMINAL_APP\"" > "$CONFIG_FILE"
        echo ""
        log_success "è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ: $TERMINAL_APP"
        echo ""
    fi
    
    # MULTIAGENTç”¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ã¿ä½œæˆ
    # PRESIDENTç”¨ã¯ç¾åœ¨ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ä½¿ç”¨
    if [ "$TERMINAL_APP" = "iTerm" ]; then
        # iTerm2ã‚’ä½¿ç”¨ - æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        osascript << EOF 2>/dev/null
tell application "iTerm"
    tell current window
        create tab with default profile
        tell current tab
            tell current session
                write text "cd '$CURRENT_DIR' && echo 'ğŸ‘¥ MULTIAGENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t multiagent"
                set name to "Multi-Claude: MULTIAGENT"
            end tell
        end tell
    end tell
end tell
EOF
    else
        # æ¨™æº–ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ä½¿ç”¨
        osascript << EOF 2>/dev/null
tell application "Terminal"
    do script "cd '$CURRENT_DIR' && echo 'ğŸ‘¥ MULTIAGENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t multiagent"
    delay 1
    set currentWindow to front window
    set currentTab to selected tab of currentWindow
    try
        tell currentTab
            set custom title to "Multi-Claude: MULTIAGENT"
        end tell
    on error
        -- ã‚¿ã‚¤ãƒˆãƒ«è¨­å®šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
    end try
end tell
EOF
    fi
    
    if [ $? -ne 0 ]; then
        log_error "MULTIAGENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo "æ‰‹å‹•ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
        echo "tmux attach-session -t multiagent"
        exit 1
    fi

elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Linux - MULTIAGENTç”¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã®ã¿ä½œæˆ
    if command -v gnome-terminal &> /dev/null; then
        # GNOME Terminal
        gnome-terminal --title="Multi-Claude: MULTIAGENT" -- bash -c "cd '$CURRENT_DIR' && echo 'ğŸ‘¥ MULTIAGENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t multiagent; exec bash" &
    elif command -v xterm &> /dev/null; then
        # xterm
        xterm -title "Multi-Claude: MULTIAGENT" -e "cd '$CURRENT_DIR' && echo 'ğŸ‘¥ MULTIAGENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t multiagent" &
    else
        log_error "å¯¾å¿œã™ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi
else
    log_error "å¯¾å¿œã—ã¦ã„ãªã„OS: $OSTYPE"
    exit 1
fi

log_success "âœ… MULTIAGENTã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦èµ·å‹•å®Œäº†"

# STEP 3.5: ç’°å¢ƒå¤‰æ•°ç¢ºèª
log_info "ğŸ”§ ç’°å¢ƒå¤‰æ•°è¨­å®šå®Œäº†..."
log_info "  MULTI_CLAUDE_GLOBAL: $MULTI_CLAUDE_GLOBAL"
log_info "  MULTI_CLAUDE_LOCAL: $MULTI_CLAUDE_LOCAL"

# STEP 4: Claude Codeè‡ªå‹•èµ·å‹•ã¨åˆæœŸã‚¿ã‚¹ã‚¯ç¢ºèª
log_info "â³ Claude Codeèµ·å‹•æº–å‚™ä¸­..."
sleep 3
log_info "ğŸ¤– Claude Codeè‡ªå‹•èµ·å‹•ä¸­..."

# MULTIAGENTèµ·å‹•ï¼ˆå…¨ãƒšã‚¤ãƒ³ï¼‰
for i in {0..5}; do
    case $i in
        0) agent_name="boss1" ;;
        1) agent_name="worker1" ;;
        2) agent_name="architect" ;;
        3) agent_name="worker2" ;;
        4) agent_name="qa" ;;
        5) agent_name="worker3" ;;
    esac
    log_info "ğŸ¤– $agent_name èµ·å‹•ä¸­..."
    # ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã‹ã‚‰Claude Codeã‚’èµ·å‹•
    tmux send-keys -t multiagent:0.$i "export MULTI_CLAUDE_LOCAL='$MULTI_CLAUDE_LOCAL'" C-m
    tmux send-keys -t multiagent:0.$i "export MULTI_CLAUDE_GLOBAL='$MULTI_CLAUDE_GLOBAL'" C-m
    if ! tmux send-keys -t multiagent:0.$i "$CLAUDE_CMD $SKIP_PERMISSIONS" C-m; then
        log_error "$agent_name ã¸ã®Claude Codeèµ·å‹•ã‚³ãƒãƒ³ãƒ‰é€ä¿¡ã«å¤±æ•—"
        exit 1
    fi
    sleep 2
done

log_success "âœ… Claude Codeèµ·å‹•å®Œäº†"

# timing_control.shã®source
TIMING_CONTROL_PATH=""
# æ–°ã—ã„ãƒ‘ã‚¹ï¼ˆbin/ï¼‰ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯
if [ -f "$PROJECT_DIR/bin/timing_control.sh" ]; then
    TIMING_CONTROL_PATH="$PROJECT_DIR/bin/timing_control.sh"
elif [ -f "$MULTI_CLAUDE_LOCAL/timing_control.sh" ]; then
    TIMING_CONTROL_PATH="$MULTI_CLAUDE_LOCAL/timing_control.sh"
elif [ -f "$PROJECT_DIR/timing_control.sh" ]; then
    TIMING_CONTROL_PATH="$PROJECT_DIR/timing_control.sh"
fi

if [ -n "$TIMING_CONTROL_PATH" ]; then
    source "$TIMING_CONTROL_PATH"
    log_info "ğŸ“Š timing_control.sh loaded from: $TIMING_CONTROL_PATH"
fi

# ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹æ¤œå‡ºã¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¶å¾¡æ©Ÿèƒ½ï¼ˆtiming_control.shçµ±åˆç‰ˆï¼‰
wait_for_claude_login() {
    local pane_id="$1"
    local agent_name="$2"
    
    # timing_control.shã®é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
    if type -t wait_for_claude_with_retry >/dev/null 2>&1; then
        log_info "ğŸ”„ é«˜åº¦ãªå¾…æ©Ÿæ©Ÿèƒ½ã‚’ä½¿ç”¨: $agent_name"
        wait_for_claude_with_retry "$pane_id" 2 5
        return $?
    fi
    
    # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®å®Ÿè£…
    local max_wait=60  # æœ€å¤§60ç§’å¾…æ©Ÿ
    local wait_interval=2  # 2ç§’é–“éš”ã§ãƒã‚§ãƒƒã‚¯
    local elapsed=0
    
    log_info "â³ $agent_name ã®Claude Codeãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
    
    while [ $elapsed -lt $max_wait ]; do
        # tmux pane-captureã§Claude Codeã®å‡ºåŠ›ã‚’å–å¾—
        local output=$(tmux capture-pane -t "$pane_id" -p 2>/dev/null || echo "")
        
        # ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        if echo "$output" | grep -q -i "ready\|claude\|assistant\|how can i help\|what can i do"; then
            log_success "âœ… $agent_name ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’ç¢ºèª"
            return 0
        fi
        
        # ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if echo "$output" | grep -q -i "login\|sign in\|authenticate"; then
            log_info "ğŸ”‘ $agent_name ã§ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’ãŠå¾…ã¡ãã ã•ã„..."
        fi
        
        sleep $wait_interval
        elapsed=$((elapsed + wait_interval))
        
        # é€²æ—è¡¨ç¤ºï¼ˆ10ç§’ã”ã¨ï¼‰
        if [ $((elapsed % 10)) -eq 0 ]; then
            log_info "â±  $agent_name å¾…æ©Ÿä¸­... (${elapsed}/${max_wait}ç§’)"
        fi
    done
    
    log_error "âš ï¸ $agent_name ã®ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (${max_wait}ç§’)"
    return 1
}

# ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å½¹å‰²ã‚’èªè­˜ã•ã›ã‚‹åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
log_info "â³ Claude Codeã®èµ·å‹•ã¨ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
# å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’å€‹åˆ¥ã«ç¢ºèª
wait_for_claude_login "multiagent:0.0" "boss1"
wait_for_claude_login "multiagent:0.1" "worker1" 
wait_for_claude_login "multiagent:0.2" "architect"
wait_for_claude_login "multiagent:0.3" "worker2"
wait_for_claude_login "multiagent:0.4" "qa"
wait_for_claude_login "multiagent:0.5" "worker3"
log_info "ğŸ¤– ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å½¹å‰²ã‚’èªè­˜ã•ã›ã¦ã„ã¾ã™..."
tmux send-keys -t multiagent:0.0 "ã‚ãªãŸã¯boss1ã§ã™ã€‚CLAUDE.mdã¨$MULTI_CLAUDE_LOCAL/instructions/boss_dynamic.mdã‚’èª­ã¿è¾¼ã‚“ã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚" C-m
tmux send-keys -t multiagent:0.1 "ã‚ãªãŸã¯worker1ã§ã™ã€‚CLAUDE.mdã¨$MULTI_CLAUDE_LOCAL/instructions/worker_dynamic.mdã‚’èª­ã¿è¾¼ã‚“ã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚" C-m
tmux send-keys -t multiagent:0.2 "ã‚ãªãŸã¯architectã§ã™ã€‚CLAUDE.mdã¨$MULTI_CLAUDE_LOCAL/instructions/architect_dynamic.mdã‚’èª­ã¿è¾¼ã‚“ã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚" C-m
tmux send-keys -t multiagent:0.3 "ã‚ãªãŸã¯worker2ã§ã™ã€‚CLAUDE.mdã¨$MULTI_CLAUDE_LOCAL/instructions/worker_dynamic.mdã‚’èª­ã¿è¾¼ã‚“ã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚" C-m
tmux send-keys -t multiagent:0.4 "ã‚ãªãŸã¯qaã§ã™ã€‚CLAUDE.mdã¨$MULTI_CLAUDE_LOCAL/instructions/qa_dynamic.mdã‚’èª­ã¿è¾¼ã‚“ã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚" C-m
tmux send-keys -t multiagent:0.5 "ã‚ãªãŸã¯worker3ã§ã™ã€‚CLAUDE.mdã¨$MULTI_CLAUDE_LOCAL/instructions/worker_dynamic.mdã‚’èª­ã¿è¾¼ã‚“ã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚" C-m

# STEP 4.5: ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèªã¨ã‚¿ã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯
log_info "ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèªä¸­..."
sleep 3

# å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«èµ·å‹•ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
log_info "ğŸ“¡ ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“é€šä¿¡ãƒ†ã‚¹ãƒˆä¸­..."

# ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
mkdir -p "$MULTI_CLAUDE_LOCAL/tasks"
echo "Multi-Claude System Started at $(date)" > "$MULTI_CLAUDE_LOCAL/tasks/system_status.txt"

# å‰å›ã®ã‚¿ã‚¹ã‚¯çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
if [ -f "$MULTI_CLAUDE_LOCAL/tasks/current_task.md" ]; then
    log_info "ğŸ“‹ å‰å›ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"
    echo ""
    echo "===== æœªå®Œäº†ã‚¿ã‚¹ã‚¯ ====="
    head -5 "$MULTI_CLAUDE_LOCAL/tasks/current_task.md"
    echo "========================"
    echo ""
    
    # PRESIDENTã«æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã®ç¢ºèªã‚’ä¿ƒã™
    sleep 2
    # ãƒ­ãƒ¼ã‚«ãƒ«ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®é †ã§ç¢ºèª
    if [ -f "$MULTI_CLAUDE_LOCAL/bin/agent-send.sh" ]; then
        $MULTI_CLAUDE_LOCAL/bin/agent-send.sh president "ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚å‰å›ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚$MULTI_CLAUDE_LOCAL/tasks/current_task.mdã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    elif [ -f "$MULTI_CLAUDE_GLOBAL/bin/agent-send.sh" ]; then
        $MULTI_CLAUDE_GLOBAL/bin/agent-send.sh president "ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚å‰å›ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚$MULTI_CLAUDE_LOCAL/tasks/current_task.mdã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    elif [ -f "$MULTI_CLAUDE_GLOBAL/agent-send.sh" ]; then
        $MULTI_CLAUDE_GLOBAL/agent-send.sh president "ã‚·ã‚¹ãƒ†ãƒ ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚å‰å›ã®æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚$MULTI_CLAUDE_LOCAL/tasks/current_task.mdã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    fi
fi

log_success "âœ… ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèªå®Œäº†"

# STEP 5: ç›´æ¥æŒ‡ç¤ºã®é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
if [ -n "$DIRECT_MESSAGE" ]; then
    log_info "ğŸ“¨ PRESIDENTã¸ç›´æ¥æŒ‡ç¤ºã‚’é€ä¿¡ä¸­..."
    sleep 2
    
    # agent-send.shã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    # ãƒ­ãƒ¼ã‚«ãƒ«ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®é †ã§ç¢ºèª
    if [ -f "$MULTI_CLAUDE_LOCAL/bin/agent-send.sh" ]; then
        $MULTI_CLAUDE_LOCAL/bin/agent-send.sh president "$DIRECT_MESSAGE"
    elif [ -f "$MULTI_CLAUDE_GLOBAL/bin/agent-send.sh" ]; then
        $MULTI_CLAUDE_GLOBAL/bin/agent-send.sh president "$DIRECT_MESSAGE"
    elif [ -f "$MULTI_CLAUDE_GLOBAL/agent-send.sh" ]; then
        $MULTI_CLAUDE_GLOBAL/agent-send.sh president "$DIRECT_MESSAGE"
    else
        log_error "agent-send.shãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi
    
    log_success "âœ… æŒ‡ç¤ºã‚’é€ä¿¡ã—ã¾ã—ãŸ"
    
    # PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¿ãƒƒãƒ
    echo ""
    echo "ğŸ” PRESIDENTã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶šä¸­..."
    echo "   çµ‚äº†ã™ã‚‹ã«ã¯: Ctrl+B â†’ D"
    sleep 2
    tmux attach-session -t president
else
    echo ""
    echo "ğŸ‰ Multi-Claude ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•å®Œäº†ï¼"
    echo "=================================="
    echo ""
    echo "ğŸ“‹ ä½¿ç”¨æ–¹æ³•:"
    echo "  1. ğŸ¯ ç¾åœ¨ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«: PRESIDENTï¼ˆãƒ¡ã‚¤ãƒ³ã®å¯¾è©±çª“å£ï¼‰"
    echo "  2. ğŸ‘¥ MULTIAGENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦: BOSS+WORKERsç›£è¦–ç”¨"
    echo ""
    echo "ğŸ’¬ PRESIDENTã«è©±ã—ã‹ã‘ã¦ã‚¿ã‚¹ã‚¯ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ï¼š"
    echo "     ä¾‹: ã€ŒPythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’3äººã§ä½œã£ã¦ã€"
    echo ""
    echo "ğŸ’¡ ç›´æ¥æŒ‡ç¤ºã‚‚å¯èƒ½:"
    echo "     multi-claude \"Pythonã§è¨ˆç®—æ©Ÿã‚’ä½œã£ã¦\""
    echo ""
    echo "ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ åˆ¶å¾¡:"
    echo "  çµ‚äº†: Ctrl+C ã§Claudeçµ‚äº†ã€tmux kill-server ã§å®Œå…¨ãƒªã‚»ãƒƒãƒˆ"
    echo "  å†èµ·å‹•: multi-claude"
    echo ""
    
    # PRESIDENTã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’èµ·å‹•
    echo "ğŸ¤– PRESIDENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’èµ·å‹•ä¸­..."
    echo "   MULTIAGENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¨PRESIDENTã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ç›£è¦–å¯èƒ½ã§ã™"
    sleep 2
    
    # presidentã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦Claude Codeã‚’èµ·å‹•
    tmux send-keys -t president:0 "export MULTI_CLAUDE_LOCAL='$MULTI_CLAUDE_LOCAL'" C-m
    tmux send-keys -t president:0 "export MULTI_CLAUDE_GLOBAL='$MULTI_CLAUDE_GLOBAL'" C-m
    tmux send-keys -t president:0 "$CLAUDE_CMD $SKIP_PERMISSIONS" C-m
    
    # PRESIDENTã®ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’ç¢ºèªã—ã¦ã‹ã‚‰æŒ‡ç¤ºã‚’é€ä¿¡
    log_info "â³ PRESIDENTã®ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’å¾…æ©Ÿä¸­..."
    wait_for_claude_login "president:0" "PRESIDENT"
    tmux send-keys -t president:0 "ã‚ãªãŸã¯PRESIDENTã§ã™ã€‚ã¾ãšã€CLAUDE.mdã¨$MULTI_CLAUDE_LOCAL/instructions/president_dynamic.mdã‚’èª­ã¿è¾¼ã‚“ã§ã€æŒ‡ç¤ºã«å¾“ã£ã¦è¡Œå‹•ã—ã¦ãã ã•ã„ã€‚" C-m
    
    # PRESIDENTç”¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’åˆ¥ã‚¿ãƒ–ã§èµ·å‹•
    if [ "$TERMINAL_APP" = "iTerm" ]; then
        # iTerm2ã‚’ä½¿ç”¨ - æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        osascript << EOF 2>/dev/null
tell application "iTerm"
    tell current window
        create tab with default profile
        tell current tab
            tell current session
                write text "cd '$CURRENT_DIR' && echo 'ğŸ‘‘ PRESIDENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t president"
                set name to "Multi-Claude: PRESIDENT"
            end tell
        end tell
    end tell
end tell
EOF
    else
        # æ¨™æº–ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’ä½¿ç”¨
        osascript << EOF 2>/dev/null
tell application "Terminal"
    do script "cd '$CURRENT_DIR' && echo 'ğŸ‘‘ PRESIDENT ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦' && tmux attach-session -t president"
    delay 1
    set currentWindow to front window
    set currentTab to selected tab of currentWindow
    try
        tell currentTab
            set custom title to "Multi-Claude: PRESIDENT"
        end tell
    on error
        -- ã‚¿ã‚¤ãƒˆãƒ«è¨­å®šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
    end try
end tell
EOF
    fi
    
    echo ""
    echo "âœ… 2ã¤ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒèµ·å‹•ã—ã¾ã—ãŸï¼š"
    echo "   1. MULTIAGENT (boss1 + worker1,2,3)"
    echo "   2. PRESIDENT (ãƒ¡ã‚¤ãƒ³ã®å¯¾è©±çª“å£)"
    echo ""
    echo "ğŸ’¡ ãƒ’ãƒ³ãƒˆ: å„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ä½œæ¥­çŠ¶æ³ã‚’ç¢ºèªã§ãã¾ã™"
fi